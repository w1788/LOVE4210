<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B-Logic v7.0 [UI TuneUp]</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore-compat.js"></script>

    <style>
        /* â˜…å…¨ä½“çš„ã«ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°‘ã—æ‹¡å¤§ */
        body { margin: 0; background: #333; font-family: sans-serif; overflow: hidden; touch-action: none; font-size: 16px; }
        #opening-screen { width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #333; color: white; padding: 20px; box-sizing: border-box; }
        #project-table-container { width: 90%; max-width: 1000px; display: flex; flex-direction: column; gap: 10px; }
        #project-table { background: white; color: #333; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #project-table table { width: 100%; border-collapse: collapse; }
        #project-table th, #project-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        #project-table th { background: #444; color: white; }
        .editable { cursor: pointer; border: 1px transparent solid; }
        .editable:hover { background-color: #f0f0f0; border: 1px #ccc solid; border-radius: 4px; }
        .editable:focus { background-color: #fff; border: 1px #007AFF solid; outline: none; }
        
        #main-application { display: none; width: 100vw; height: 100vh; flex-direction: column; }
        
        #top-navbar { height: 60px; background: #222; color: white; display: flex; align-items: center; padding: 0 10px; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 10; }
        #top-navbar .group { display: flex; gap: 8px; align-items: center; }
        .top-btn { padding: 10px 15px; cursor: pointer; border-radius: 6px; border: none; font-weight: bold; font-size: 15px; }
        .btn-layer { background: #555; color: white; }
        .btn-layer.active { background: #007AFF; }
        
        #content-area { flex-grow: 1; display: flex; overflow: hidden; }
        
        #sidebar { width: 250px; background: #f8f9fa; padding: 10px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 10; height: 100%; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; }
        
        #canvas-container { flex-grow: 1; position: relative; background: #333; overflow: hidden; }
        .canvas-container { position: absolute !important; top: 0; left: 0; }
        
        select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 15px; font-weight: bold; background: #fff; }
        .main-btn { width: 100%; padding: 12px; cursor: pointer; border-radius: 8px; border: none; background: #007AFF; color: white; font-weight: bold; font-size: 15px; }
        .btn-green { background: #28a745; } .btn-orange { background: #ff9500; } .btn-red { background: #dc3545; } .btn-panel { background: #6c757d; }
        .grade-group { display: flex; gap: 4px; }
        .grade-group button { flex: 1; padding: 10px; cursor: pointer; background: #eee; border: 1px solid #ccc; border-radius: 4px; font-weight: bold; font-size: 16px; }
        .grade-group button.active { background: #ff9500 !important; color: white !important; }
        .floating-win { display: none; position: fixed; background: white; z-index: 100; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); overflow: hidden; max-width: 95vw; max-height: 90vh; }
        .win-header { background: #444; color: white; padding: 10px; cursor: move; display: flex; justify-content: space-between; align-items: center; font-size: 15px; }
        .win-header button { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        #numpad-win { width: 260px; top: 100px; left: 280px; }
        .num-display { width: 100%; height: 50px; background: #eee; border: none; text-align: right; font-size: 24px; padding: 5px; box-sizing: border-box; }
        .num-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; padding: 10px; }
        .num-grid button { padding: 15px; font-size: 20px; font-weight: bold; border-radius: 8px; border: 1px solid #ccc; background: #fff; }
        .num-grid .btn-enter { background: #007AFF; color: white; grid-column: span 3; }
        #photo-overlay { width: 380px; height: 500px; top: 50px; left: 550px; resize: both; }
        #pop-img-container { height: calc(100% - 40px); overflow-y: auto; padding: 10px; background: #eee; }
        #pop-img-container img { width: 100%; border-radius: 4px; margin-bottom: 10px; }
        #pdf-win { width: 650px; height: 850px; top: 50px; left: 300px; resize: both; min-width: 300px; min-height: 400px; }
        #pdf-container { height: calc(100% - 40px); width: 100%; overflow: auto; background: #ccc; display:block; cursor: grab; position: relative; }
        #pdf-container.grabbing { cursor: grabbing; }
        #pdf-canvas { border: 1px solid #999; user-select: none; }
        .pdf-overlay-controls { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; background: rgba(0, 0, 0, 0.6); padding: 5px; border-radius: 25px; z-index: 101; }
        .pdf-overlay-controls button { padding: 5px 10px; cursor: pointer; border-radius: 20px; border: none; background: white; font-weight: bold; font-size: 14px; }
        .pdf-overlay-controls span { color: white; display: flex; align-items: center; font-weight: bold; font-size: 14px; min-width: 50px; justify-content: center; }
        .active-mode { border: 3px solid #ff3b30 !important; background: #fff1f0 !important; }
        
        #right-controls { position: absolute; bottom: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 5px; }
        #right-controls button { width: 60px; height: 60px; font-size: 24px; font-weight: bold; border-radius: 30px; border: none; background: rgba(0,0,0,0.5); color: white; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        #right-controls button:active { background: rgba(0,0,0,0.8); }
        #right-controls button.active { background: #ff3b30; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="opening-screen">
    <h1>B-Logic ç‚¹æ¤œã‚·ã‚¹ãƒ†ãƒ </h1>
    <div id="project-table-container">
        <div id="project-table">
            <table id="main-table">
                <thead>
                    <tr>
                        <th>æ§‹é€ ç‰©å</th>
                        <th>ç‚¹æ¤œæ—¥</th>
                        <th>â‘ æå‚·å›³PDF(èƒŒæ™¯)</th>
                        <th>â‘¡å‰å›èª¿æ›¸PDF(å‚ç…§)</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <tr>
                        <td class="editable" contenteditable="true">Aæ©‹</td>
                        <td class="editable" contenteditable="true">2026/02/06</td>
                        <td><input type="file" id="damage-file-0" accept=".pdf"></td>
                        <td><input type="file" id="report-file-0" accept=".pdf"></td>
                        <td><button class="main-btn btn-green" onclick="startInspection(0)">ç‚¹æ¤œé–‹å§‹</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <button class="main-btn btn-panel" style="width: auto; align-self: flex-start;" onclick="addRow()">ï¼‹ è¡Œã‚’è¿½åŠ </button>
    </div>
</div>

<div id="main-application">
    <div id="top-navbar">
        <div class="group">
            <button class="top-btn btn-layer" onclick="backToDashboard()">â—€ çµ‚äº†</button>
            <span style="font-size:14px; font-weight:bold;">â— ãƒ¬ã‚¤ãƒ¤ãƒ¼:</span>
            <button id="layer-a" class="top-btn btn-layer active" onclick="setLayer('userA')">A</button>
            <button id="layer-b" class="top-btn btn-layer" onclick="setLayer('userB')">B</button>
        </div>
        <div class="group">
            <button class="top-btn btn-layer" style="background:#343a40;" onclick="saveLayeredDataFirebase()">ğŸ’¾ä¿å­˜</button>
            <button class="top-btn btn-layer" style="background:#5a6268;" onclick="loadAndMergeDataFirebase()">ğŸ“‚èª­è¾¼</button>
            <button class="top-btn btn-layer" style="background:#dc3545;" onclick="deleteObject()">ğŸ—‘ï¸å‰Šé™¤</button>
            <button class="top-btn btn-layer" style="background:#28a745;" onclick="saveAsPDF()">ğŸ“„PDF</button>
        </div>
    </div>

    <div id="content-area">
        <div id="sidebar">
            <div id="shape-mode-panel" style="background:#eee; padding:5px; border-radius:8px; border: 2px solid transparent;">
                <span style="font-size:13px; font-weight:bold; color:#007AFF;">â— å›³é¢è¨˜å·</span>
                <select id="shape-type"><option value="ellipse">æ¥•å††å½¢</option><option value="rect">é•·æ–¹å½¢</option></select>
                <select id="hatch-type" style="margin-top:4px;">
                    <option value="none">ãªã—</option>
                    <option value="hibi_free">ã²ã³ã‚ã‚Œï¼ˆæ‰‹æ›¸ãï¼‰</option> 
                    <option value="hakuri">å‰¥é›¢</option><option value="lime">éŠé›¢çŸ³ç°</option>
                    <option value="tekin">é‰„ç­‹éœ²å‡º</option><option value="uki">ã†ã</option><option value="rousui">æ¼æ°´</option><option value="fushoku">è…é£Ÿ</option>
                </select>
                <button id="shape-draw-btn" class="main-btn" style="margin-top:4px; padding:8px; font-size:14px;" onclick="toggleShapeMode()">é…ç½®ãƒ¢ãƒ¼ãƒ‰</button>
            </div>

            <button class="main-btn btn-green" style="font-size:14px;" onclick="toggleStepPanel()">ğŸš© æ——æšã’</button>
            <div id="step-panel" style="display:none; background:#fff; border:2px solid #007AFF; padding:5px; border-radius:8px;">
                <select id="damage-type" onchange="showGradeStep()"><option value="">æå‚·ã‚’é¸æŠ...</option></select>
                <div id="grade-step" style="display:none; margin-top:5px;">
                    <div class="grade-group">
                        <button onclick="setGrade(this,'a')">a</button><button onclick="setGrade(this,'b')">b</button><button onclick="setGrade(this,'c')">c</button><button onclick="setGrade(this,'d')">d</button><button onclick="setGrade(this,'e')">e</button>
                    </div>
                </div>
            </div>

            <button class="main-btn" style="background:#ff9500; font-size:14px;" onclick="openNumpad()">ğŸ“ å¯¸æ³•å…¥åŠ›</button>
            <button class="main-btn" style="background:#6c757d; font-size:14px;" onclick="addFreeText()">ï¼´ ãƒ†ã‚­ã‚¹ãƒˆ</button>
            
            <div id="photo-action-panel" class="hidden" style="display:flex; flex-direction:column; gap:8px; background:#e9ecef; padding:8px; border-radius:8px;">
                <span style="font-size:12px; font-weight:bold; color:#555; text-align:center;">â— é¸æŠä¸­ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ</span>
                <button class="main-btn btn-green" style="font-size:14px; background:#17a2b8;" onclick="document.getElementById('file-input').click()">ğŸ“· å†™çœŸè¿½åŠ </button>
                <button class="main-btn btn-green" style="font-size:14px;" onclick="viewSelectedPhotos()">ğŸ–¼ï¸ å†™çœŸè¡¨ç¤º</button>
            </div>
            
            <button class="main-btn" style="background:#6c757d; font-size:14px; margin-top:10px;" onclick="openReportWindow()">ğŸ“„ å‰å›èª¿æ›¸</button>
        </div>
        
        <div id="canvas-container">
            <canvas id="c"></canvas>
            <div id="right-controls">
                <button id="pan-mode-btn" onclick="togglePanMode()">ğŸ–ï¸</button>
                <button onclick="zoomBtn(1.2)">ï¼‹</button>
                <button onclick="zoomBtn(0.8)">ãƒ¼</button>
                <button onclick="resetViewport()" style="font-size:18px;">å…¨æ™¯</button>
            </div>
        </div>
    </div>
</div>

<div id="numpad-win" class="floating-win">
    <div class="win-header"><span>å¯¸æ³•å…¥åŠ›</span><button onclick="closeWin('numpad-win')">Ã—</button></div>
    <input type="text" id="num-display" class="num-display" readonly placeholder="0">
    <div class="num-grid">
        <button onclick="pressNum('7')">7</button><button onclick="pressNum('8')">8</button><button onclick="pressNum('9')">9</button>
        <button onclick="pressNum('4')">4</button><button onclick="pressNum('5')">5</button><button onclick="pressNum('6')">6</button>
        <button onclick="pressNum('1')">1</button><button onclick="pressNum('2')">2</button><button onclick="pressNum('3')">3</button>
        <button onclick="pressNum('0')">0</button><button onclick="pressNum('Ã—')">Ã—</button><button onclick="pressNum('/')">/</button>
        <button onclick="pressNum('C')" style="color:red;">C</button><button onclick="pressNum('DEL')">â†</button><button onclick="pressNum('.')">.</button>
        <button class="btn-enter" onclick="confirmDim()">é…ç½®</button>
    </div>
</div>

<div id="photo-overlay" class="floating-win">
    <div class="win-header"><span id="pop-title">å†™çœŸ</span><button onclick="closeWin('photo-overlay')">Ã—</button></div>
    <div id="pop-img-container"></div>
</div>

<div id="pdf-win" class="floating-win">
    <div class="win-header">
        <span>å‰å›èª¿æ›¸PDF</span>
        <button onclick="closeWin('pdf-win')">Ã—</button>
    </div>
    <div id="pdf-container">
        <canvas id="pdf-canvas"></canvas>
    </div>
    <div class="pdf-overlay-controls">
        <button onclick="zoomOut()">ï¼</button>
        <button onclick="prevPage()">â—€ å‰</button>
        <span id="page-num">1 / 1</span>
        <button onclick="nextPage()">æ¬¡ â–¶</button>
        <button onclick="zoomIn()">ï¼‹</button>
    </div>
</div>

<input type="file" id="file-input" style="display:none" accept="image/*" multiple onchange="handleFiles(this)">

<script>
    const canvas = new fabric.Canvas('c', { backgroundColor: '#fff', selection: true });
    const PITCH = 30; const patternCache = {};
    const damages = ["01:è…é£Ÿ", "02:äº€è£‚", "03:ã‚†ã‚‹ã¿ãƒ»è„±è½", "04:ç ´æ–­", "05:é˜²é£Ÿæ©Ÿèƒ½ã®åŠ£åŒ–", "06:ã²ã³ã‚ã‚Œ", "07:å‰¥é›¢ãƒ»é‰„ç­‹éœ²å‡º", "08:æ¼æ°´ãƒ»éŠé›¢çŸ³ç°", "09:æŠœã‘è½ã¡", "10:è£œä¿®ãƒ»è£œå¼·æã®æå‚·", "11:åºŠæ¿ã²ã³ã‚ã‚Œ", "12:ã†ã", "13:éŠé–“ã®ç•°å¸¸", "14:è·¯é¢ã®å‡¹å‡¸", "15:èˆ—è£…ã®ç•°å¸¸", "16:æ”¯æ‰¿éƒ¨ã®æ©Ÿèƒ½éšœå®³", "17:ãã®ä»–", "18:å®šç€éƒ¨ã®ç•°å¸¸", "19:å¤‰è‰²ãƒ»åŠ£åŒ–", "20:æ¼æ°´ãƒ»å¸¯æ°´", "21:ç•°å¸¸ãªéŸ³ãƒ»æŒ¯å‹•", "22:ç•°å¸¸ãªãŸã‚ã¿", "23:å¤‰å½¢ãƒ»æ¬ æ", "24:åœŸç ‚è©°ã¾ã‚Š", "25:æ²ˆä¸‹ãƒ»ç§»å‹•ãƒ»å‚¾æ–œ", "26:æ´—å €"];
    const select = document.getElementById('damage-type');
    damages.forEach(d => { let opt = document.createElement('option'); opt.value = d; opt.innerText = d; select.appendChild(opt); });

    let currentLayer = 'userA';
    let activeMode = null; let currentGrade = "";
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let isPanMode = false;

    let rowCounter = 1;
    function addRow() {
        const tbody = document.getElementById('table-body');
        const row = document.createElement('tr');
        const id = rowCounter++;
        row.innerHTML = `<td class="editable" contenteditable="true">æ–°è¦æ§‹é€ ç‰©</td><td class="editable" contenteditable="true">${new Date().toLocaleDateString('ja-JP')}</td><td><input type="file" id="damage-file-${id}" accept=".pdf"></td><td><input type="file" id="report-file-${id}" accept=".pdf"></td><td><button class="main-btn btn-green" onclick="startInspection(${id})">ç‚¹æ¤œé–‹å§‹</button></td>`;
        tbody.appendChild(row);
    }

    function setLayer(layer) {
        currentLayer = layer;
        document.getElementById('layer-a').classList.toggle('active', layer === 'userA');
        document.getElementById('layer-b').classList.toggle('active', layer === 'userB');
    }

    function loadDamagePdfToMainCanvas(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            pdfjsLib.getDocument(new Uint8Array(e.target.result)).promise.then(function(pdfDoc_) {
                pdfDoc_.getPage(1).then(function(page) {
                    const viewport = page.getViewport({ scale: 2.0 });
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCanvas.height = viewport.height;
                    tempCanvas.width = viewport.width;
                    page.render({ canvasContext: tempCtx, viewport: viewport }).promise.then(function() {
                        canvas.setWidth(viewport.width);
                        canvas.setHeight(viewport.height);
                        fabric.Image.fromURL(tempCanvas.toDataURL(), function(img) {
                            img.set({ selectable: false, evented: false, layerId: 'background' });
                            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                            resetViewport();
                        });
                    });
                });
            });
        };
        reader.readAsArrayBuffer(file);
    }

    function togglePanMode() {
        isPanMode = !isPanMode;
        const btn = document.getElementById('pan-mode-btn');
        if (isPanMode) {
            btn.classList.add('active');
            canvas.defaultCursor = 'grab';
            canvas.selection = false;
        } else {
            btn.classList.remove('active');
            canvas.defaultCursor = 'default';
            canvas.selection = true;
        }
    }

    let isDragging = false;
    let lastPosX, lastPosY;
    let zoomLevel = 1;
    const MAX_ZOOM = 5;
    const MIN_ZOOM = 0.5;

    canvas.on('mouse:down', function(opt) {
        var evt = opt.e;
        if (isPanMode && !opt.target) {
            isDragging = true;
            canvas.setCursor('grabbing');
            lastPosX = evt.clientX || (evt.touches ? evt.touches[0].clientX : 0);
            lastPosY = evt.clientY || (evt.touches ? evt.touches[0].clientY : 0);
        }
    });

    canvas.on('mouse:move', function(opt) {
        if (isDragging) {
            var e = opt.e;
            var vpt = canvas.viewportTransform;
            let curX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            let curY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
            vpt[4] += curX - lastPosX;
            vpt[5] += curY - lastPosY;
            canvas.requestRenderAll();
            lastPosX = curX;
            lastPosY = curY;
        }
    });

    canvas.on('mouse:up', function(opt) {
        isDragging = false;
        canvas.setCursor(isPanMode ? 'grab' : 'default');
    });

    function zoomBtn(factor) {
        const center = canvas.getCenter();
        const point = new fabric.Point(center.left, center.top);
        zoomLevel = canvas.getZoom() * factor;
        if (zoomLevel > MAX_ZOOM) zoomLevel = MAX_ZOOM;
        if (zoomLevel < MIN_ZOOM) zoomLevel = MIN_ZOOM;
        canvas.zoomToPoint(point, zoomLevel);
    }

    function resetViewport() {
        canvas.setZoom(1);
        canvas.viewportTransform[4] = 0;
        canvas.viewportTransform[5] = 0;
        canvas.renderAll();
    }

    let currentReportFile = null;
    let reportPdfDoc = null; let reportPageNum = 1; let reportScale = 1.0;
    const pdfContainer = document.getElementById('pdf-container');
    const pdfCanvas = document.getElementById('pdf-canvas'), ctx = pdfCanvas.getContext('2d');

    function renderReportPage(num) {
        if (!reportPdfDoc) return;
        reportPdfDoc.getPage(num).then(function(page) {
            const viewport = page.getViewport({ scale: reportScale });
            pdfCanvas.height = viewport.height;
            pdfCanvas.width = viewport.width;
            page.render({ canvasContext: ctx, viewport: viewport });
            document.getElementById('page-num').textContent = num + ' / ' + reportPdfDoc.numPages;
        });
    }

    function openReportWindow() {
        if (!currentReportFile) { alert("å‰å›èª¿æ›¸PDFã‚’é¸æŠã—ã¦ãã‚Œï¼"); return; }
        const win = document.getElementById('pdf-win');
        win.style.display = 'block';
        win.style.top = "50px"; win.style.left = "300px";
        reportScale = 1.0;
        const reader = new FileReader();
        reader.onload = function(e) {
            pdfjsLib.getDocument(new Uint8Array(e.target.result)).promise.then(function(pdfDoc_) {
                reportPdfDoc = pdfDoc_; reportPageNum = 1; renderReportPage(reportPageNum);
            });
        };
        reader.readAsArrayBuffer(currentReportFile);
    }
    
    function zoomIn() { reportScale += 0.25; renderReportPage(reportPageNum); }
    function zoomOut() { if (reportScale <= 0.5) return; reportScale -= 0.25; renderReportPage(reportPageNum); }
    function prevPage() { if (reportPageNum <= 1) return; reportPageNum--; renderReportPage(reportPageNum); }
    function nextPage() { if (reportPageNum >= reportPdfDoc.numPages) return; reportPageNum++; renderReportPage(reportPageNum); }

    let isPdfDragging = false; let pStartX, pStartY, pScrollLeft, pScrollTop;
    pdfContainer.addEventListener('mousedown', (e) => {
        if (e.target.tagName === 'BUTTON') return;
        isPdfDragging = true; pdfContainer.classList.add('grabbing');
        pStartX = e.pageX - pdfContainer.offsetLeft; pStartY = e.pageY - pdfContainer.offsetTop;
        pScrollLeft = pdfContainer.scrollLeft; pScrollTop = pdfContainer.scrollTop;
    });
    window.addEventListener('mouseup', () => { isPdfDragging = false; pdfContainer.classList.remove('grabbing'); });
    pdfContainer.addEventListener('mousemove', (e) => {
        if (!isPdfDragging) return;
        e.preventDefault();
        const x = e.pageX - pdfContainer.offsetLeft; const y = e.pageY - pdfContainer.offsetTop;
        pdfContainer.scrollLeft = pScrollLeft - (x - pStartX);
        pdfContainer.scrollTop = pScrollTop - (y - pStartY);
    });

    function toggleShapeMode() {
        activeMode = (activeMode === 'shape') ? null : 'shape';
        const isHibi = document.getElementById('hatch-type').value === 'hibi_free';
        canvas.isDrawingMode = (activeMode === 'shape' && isHibi);
        if (canvas.isDrawingMode) {
            canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
            canvas.freeDrawingBrush.width = 3; canvas.freeDrawingBrush.color = 'red';
        }
        updateUI();
    }
    canvas.on('path:created', function(e) {
        e.path.set({ layerId: currentLayer });
        if (activeMode === 'shape' && canvas.isDrawingMode) { activeMode = null; canvas.isDrawingMode = false; updateUI(); }
    });
    function toggleStepPanel() { const p = document.getElementById('step-panel'); activeMode = (p.style.display==='block')?null:'flag'; p.style.display = (activeMode==='flag')?'block':'none'; canvas.isDrawingMode = false; updateUI(); }
    function updateUI() {
        document.getElementById('shape-mode-panel').classList.toggle('active-mode', activeMode === 'shape');
        const btn = document.getElementById('shape-draw-btn');
        if (activeMode === 'shape') { const isHibi = document.getElementById('hatch-type').value === 'hibi_free'; btn.innerText = isHibi ? 'æç”»ä¸­...' : 'é…ç½®ä¸­...'; }
        else { btn.innerText = 'é…ç½®ãƒ¢ãƒ¼ãƒ‰'; }
    }
    function applyLegend(obj) {
        if (!obj || !obj.hatchType || obj.hatchType === 'hibi_free') return;
        const type = obj.hatchType;
        if (obj._extra) obj._extra.forEach(e => canvas.remove(e)); obj._extra = [];
        obj.set({ fill: 'transparent', stroke: 'red', strokeWidth: 2, strokeUniform: true });
        if (['tekin', 'uki', 'rousui', 'fushoku'].includes(type)) {
            const pat = getInfinitePattern(type);
            const sX = 1/(obj.scaleX||1), sY = 1/(obj.scaleY||1), r = -(obj.angle||0)*Math.PI/180;
            const cR = Math.cos(r), sR = Math.sin(r), ctr = obj.getCenterPoint(), s = 5000;
            pat.patternTransform = [sX*cR, sX*sR, -sY*sR, sY*cR, (-ctr.x-s/2)*sX*cR+(ctr.y+s/2)*sX*sR, (-ctr.x-s/2)*sY*sR-(ctr.y+s/2)*sY*cR];
            obj.set('fill', pat);
        } else if (type==='hakuri'||type==='lime') {
            const w=obj.getScaledWidth(), h=obj.getScaledHeight();
            if (type==='hakuri') {
                const inner = (obj.type==='rect') ? new fabric.Rect({width:w-20, height:h-20}) : new fabric.Ellipse({rx:Math.max(0,(w-20)/2), ry:Math.max(0,(h-20)/2)});
                inner.set({ left: obj.left, top: obj.top, angle: obj.angle, originX: 'center', originY: 'center', fill: 'transparent', stroke: 'red', strokeDashArray: [5,5], selectable: false, evented: false, strokeUniform: true });
                canvas.add(inner); obj._extra.push(inner);
            } else if (type==='lime') {
                const count = Math.floor(((w+h)*Math.PI/2)/25);
                for(let i=0; i<count; i++){
                    const a = (i/count)*Math.PI*2;
                    const sx = obj.left + (w/2)*Math.cos(a + obj.angle*Math.PI/180), sy = obj.top + (h/2)*Math.sin(a + obj.angle*Math.PI/180);
                    const vx = obj.left-sx, vy = obj.top-sy, dist = Math.sqrt(vx*vx+vy*vy);
                    const l = new fabric.Line([sx, sy, sx+(vx/dist)*12, sy+(vy/dist)*12], { stroke: 'red', strokeWidth: 1.5, selectable: false, evented: false });
                    canvas.add(l); obj._extra.push(l);
                }
            }
        }
    }
    function handleAllUpdate(p) {
        if (p.hatchType) applyLegend(p);
        if (p.isFlag) {
            const tipPos = { x: p.tip.left, y: p.tip.top };
            const isRight = p.left > tipPos.x;
            const jointX = isRight ? p.left-5 : p.left+p.getScaledWidth()+5;
            const jointY = p.top + p.getScaledHeight()-2;
            p.shoulder.set({ x1: jointX, y1: jointY, x2: isRight?jointX+130:jointX-130, y2: jointY });
            p.leader.set({ x1: tipPos.x, y1: tipPos.y, x2: jointX, y2: jointY });
        }
        if (p.name === 'tip') {
            const isRight = p.parentText.left > p.left;
            const jointX = isRight ? p.parentText.left-5 : p.parentText.left+p.parentText.getScaledWidth()+5;
            const jointY = p.parentText.top + p.parentText.getScaledHeight()-2;
            p.line.set({ x1: p.left, y1: p.top, x2: jointX, y2: jointY });
            p.parentText.shoulder.set({ x1: jointX, y1: jointY, x2: isRight?jointX+130:jointX-130, y2: jointY });
        }
        canvas.renderAll();
    }
    canvas.on({
        'object:moving': (e) => handleAllUpdate(e.target),
        'object:scaling': (e) => { if (e.target.hatchType) applyLegend(e.target); },
        'object:rotating': (e) => { if (e.target.hatchType) applyLegend(e.target); },
        'mouse:down': function(opt) {
            const p = canvas.getPointer(opt.e);
            const isHibi = document.getElementById('hatch-type').value === 'hibi_free';
            if (activeMode === 'shape' && !isHibi && !opt.target) {
                const props = { left: p.x, top: p.y, fill: 'transparent', stroke: 'red', strokeWidth: 2, strokeUniform: true, hatchType: document.getElementById('hatch-type').value, originX: 'center', originY: 'center', layerId: currentLayer };
                let obj = (document.getElementById('shape-type').value==='rect') ? new fabric.Rect({...props, width:140, height:80}) : new fabric.Ellipse({...props, rx:70, ry:40});
                canvas.add(obj); applyLegend(obj); canvas.setActiveObject(obj); canvas._setupCurrentTransform(opt.e, obj, true); activeMode = null; updateUI();
            } else if (activeMode === 'flag' && currentGrade && !opt.target) {
                addFlag(select.value + " (" + currentGrade + ")", p.x, p.y);
                const activeText = canvas.getObjects().slice(-2)[0]; canvas.setActiveObject(activeText); canvas._setupCurrentTransform(opt.e, activeText, true);
                activeMode = null; document.getElementById('step-panel').style.display='none'; updateUI();
            }
        },
        'selection:created': showPhotoPanel,
        'selection:updated': showPhotoPanel,
        'selection:cleared': hidePhotoPanel
    });
    
    // â˜…ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé¸æŠæ™‚ã®å†™çœŸãƒœã‚¿ãƒ³è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£
    function showPhotoPanel(e) {
        if (e.selected[0]) {
            // å›³å½¢ã¾ãŸã¯æ——æšã’ã‚’é¸æŠã—ã¦ã„ã‚‹å ´åˆã«å†™çœŸãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
            document.getElementById('photo-action-panel').classList.remove('hidden');
        } else {
            hidePhotoPanel();
        }
    }
    function hidePhotoPanel() {
        document.getElementById('photo-action-panel').classList.add('hidden');
    }

    let flagIdCounter = 0;
    function addFlag(label, x, y) {
        flagIdCounter++;
        const id = 'f' + flagIdCounter;
        const text = new fabric.IText(label + " [0æš]", { left: x + 15, top: y - 28, fontSize: 18, fontWeight: 'bold', fill: 'blue', hasControls: false, isFlag: true, flagId: label, photos: [], id: id, layerId: currentLayer });
        const shoulder = new fabric.Line([x, y, x + 140, y], { stroke: 'blue', strokeWidth: 2, selectable: false, evented: false, id: id + '-shoulder', layerId: currentLayer });
        const leader = new fabric.Line([x - 60, y + 60, x, y], { stroke: 'blue', strokeWidth: 2, selectable: false, evented: false, id: id + '-leader', layerId: currentLayer });
        const tip = new fabric.Circle({ left: x - 60, top: y + 60, radius: 8, fill: 'blue', originX: 'center', originY: 'center', hasControls: false, hasBorders: false, name: 'tip', id: id + '-tip', layerId: currentLayer });
        text.shoulder = shoulder; text.leader = leader; text.tip = tip; tip.parentText = text; tip.line = leader;
        canvas.add(leader, shoulder, text, tip); canvas.renderAll();
    }
    
    const getInfinitePattern = (type) => {
        if (patternCache[type]) return patternCache[type];
        const s = 5000; const pCanvas = document.createElement('canvas'); pCanvas.width = s; pCanvas.height = s; const ctx = pCanvas.getContext('2d');
        ctx.strokeStyle = 'red'; ctx.lineWidth = 1.5;
        let degs = (type==='tekin')?[-90]:(type==='uki')?[-90,0]:(type==='rousui')?[-45]:(type==='fushoku')?[35]:[];
        degs.forEach(deg => {
            const rad = deg * Math.PI / 180; const cos = Math.cos(rad); const sin = Math.sin(rad);
            for (let i = -s; i <= s; i += PITCH) {
                const x0 = s/2 + i * (-sin); const y0 = s/2 + i * cos;
                ctx.beginPath(); ctx.moveTo(x0 - s*cos, y0 - s*sin); ctx.lineTo(x0 + s*cos, y0 + s*sin); ctx.stroke();
            }
        });
        const pat = new fabric.Pattern({ source: pCanvas, repeat: 'no-repeat' }); patternCache[type] = pat; return pat;
    };
    const disp = document.getElementById('num-display');
    function openNumpad() { document.getElementById('numpad-win').style.display = 'block'; disp.value = ''; }
    function pressNum(val) { if (val === 'C') disp.value = ''; else if (val === 'DEL') disp.value = disp.value.slice(0, -1); else disp.value += val; }
    function confirmDim() { if (!disp.value) return; const txt = new fabric.IText(disp.value, { left: 300, top: 300, fontSize: 24, fontWeight: 'bold', fill: '#000', backgroundColor: 'rgba(255,255,0,0.5)', padding: 5, layerId: currentLayer }); canvas.add(txt).setActiveObject(txt); closeWin('numpad-win'); }
    function closeWin(id) { document.getElementById(id).style.display = 'none'; }
    function setGrade(btn, g) { currentGrade = g; document.querySelectorAll('.grade-group button').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
    function showGradeStep() { if (select.value) document.getElementById('grade-step').style.display = 'block'; }
    function addFreeText() { canvas.add(new fabric.IText('ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›', { left: 150, top: 150, fontSize: 20, fill: '#333', layerId: currentLayer })); }
    
    function deleteObject() { const a = canvas.getActiveObject(); if (a) { if (a.shoulder) canvas.remove(a.shoulder, a.leader, a.tip); if (a._extra) a._extra.forEach(e => canvas.remove(e)); canvas.remove(a); canvas.renderAll(); hidePhotoPanel(); } }
    
    function handleFiles(input) { const a = canvas.getActiveObject(); if (!a) return; 
        Array.from(input.files).forEach(f => { const r = new FileReader(); r.onload = (e) => {
            if(!a.photos) a.photos = [];
            a.photos.push(e.target.result);
            if(a.isFlag) a.set('text', a.flagId + " [" + a.photos.length + "æš]");
            canvas.renderAll();
        }; r.readAsDataURL(f); });
    }
    
    function viewSelectedPhotos() {
        const a = canvas.getActiveObject();
        if (!a || !a.photos || a.photos.length === 0) { alert("å†™çœŸãŒãªã„ã‹ã€å†™çœŸä»˜ãã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ãªã„ãœï¼"); return; }
        document.getElementById('pop-title').innerText = a.isFlag ? a.flagId : "å›³å½¢ç”»åƒ";
        const c = document.getElementById('pop-img-container'); c.innerHTML = '';
        a.photos.forEach(s => { const i = document.createElement('img'); i.src = s; c.appendChild(i); });
        document.getElementById('photo-overlay').style.display = 'block';
    }

    const firebaseConfig = {
      apiKey: "AIzaSyAyyafLY-Nccm-yI8SdwtVAbZaWRvDwXes",
      authDomain: "bridge-inspection-tool.firebaseapp.com",
      projectId: "bridge-inspection-tool",
      storageBucket: "bridge-inspection-tool.firebasestorage.app",
      messagingSenderId: "95922818409",
      appId: "1:95922818409:web:f0a5cc4c936da1812641f8",
      measurementId: "G-YHL02XYCN2"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const docId = "test-project-001";

    function saveLayeredDataFirebase() {
        const json = canvas.toJSON(['hatchType', 'isFlag', 'flagId', 'photos', 'id', 'name', 'layerId']);
        db.collection("layered_inspections").doc(docId).set({
            [currentLayer]: JSON.stringify(json),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true })
        .then(() => alert(currentLayer + " ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ãŸãœï¼"))
        .catch((error) => alert("ä¿å­˜å¤±æ•—ã ãœ...: " + error));
    }

    function loadAndMergeDataFirebase() {
        db.collection("layered_inspections").doc(docId).get()
        .then((doc) => {
            if (doc.exists) {
                const docData = doc.data();
                const bgImage = canvas.backgroundImage;
                canvas.clear();
                canvas.setBackgroundImage(bgImage, canvas.renderAll.bind(canvas));
                for (const userId in docData) {
                    if (userId === 'updatedAt') continue;
                    const jsonData = JSON.parse(docData[userId]);
                    canvas.loadFromJSON(jsonData, function() {
                        rebuildObjects();
                        canvas.renderAll();
                    });
                }
                alert("çµ±åˆã—ãŸãœï¼");
            } else alert("ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãœã€‚");
        })
        .catch((error) => alert("èª­ã¿è¾¼ã¿å¤±æ•—ã ãœ...: " + error));
    }
    
    function rebuildObjects() {
        const objects = canvas.getObjects();
        objects.forEach(obj => {
            if (obj.hatchType) applyLegend(obj);
            if (obj.isFlag) {
                const id = obj.id;
                obj.shoulder = objects.find(o => o.id === id + '-shoulder');
                obj.leader = objects.find(o => o.id === id + '-leader');
                obj.tip = objects.find(o => o.id === id + '-tip');
                if (obj.tip) {
                    obj.tip.parentText = obj;
                    obj.tip.line = obj.leader;
                }
            }
        });
    }

    function startInspection(rowId) {
        const damageFile = document.getElementById(`damage-file-${rowId}`);
        const reportFile = document.getElementById(`report-file-${rowId}`);
        if (damageFile.files.length === 0) { alert("æå‚·å›³PDFã‚’é¸æŠã—ã¦ãã‚Œï¼"); return; }
        currentReportFile = reportFile.files.length > 0 ? reportFile.files[0] : null;
        loadDamagePdfToMainCanvas(damageFile.files[0]);
        document.getElementById('opening-screen').style.display = 'none';
        document.getElementById('main-application').style.display = 'flex';
    }
    function backToDashboard() {
        document.getElementById('opening-screen').style.display = 'flex';
        document.getElementById('main-application').style.display = 'none';
        canvas.clear();
        canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas));
    }

    [document.getElementById('numpad-win'), document.getElementById('photo-overlay'), document.getElementById('pdf-win')].forEach(win => {
        const h = win.querySelector('.win-header'); let isD = false; let ox, oy;
        h.onmousedown = (e) => { isD = true; ox = e.clientX - win.offsetLeft; oy = e.clientY - win.offsetTop; };
        h.ontouchstart = (e) => { isD = true; const t = e.touches[0]; ox = t.clientX - win.offsetLeft; oy = t.clientY - win.offsetTop; };
        window.addEventListener('mousemove', (e) => { if(isD){ 
            let x = e.clientX-ox; let y = e.clientY-oy;
            x = Math.max(0, Math.min(x, window.innerWidth - win.offsetWidth));
            y = Math.max(0, Math.min(y, window.innerHeight - win.offsetHeight));
            win.style.left = x+'px'; win.style.top = y+'px'; 
        }});
        window.addEventListener('touchmove', (e) => { if(isD){ 
            const t = e.touches[0];
            let x = t.clientX-ox; let y = t.clientY-oy;
            x = Math.max(0, Math.min(x, window.innerWidth - win.offsetWidth));
            y = Math.max(0, Math.min(y, window.innerHeight - win.offsetHeight));
            win.style.left = x+'px'; win.style.top = y+'px'; 
        }});
        window.addEventListener('mouseup', () => isD = false); window.addEventListener('touchend', () => isD = false);
    });

    function saveAsPDF() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
            unit: 'px',
            format: [canvas.width, canvas.height]
        });
        const dataURL = canvas.toDataURL({ format: 'png', quality: 1.0, multiplier: 1 });
        pdf.addImage(dataURL, 'PNG', 0, 0, canvas.width, canvas.height);
        pdf.save("layered_inspection_result.pdf");
        alert("PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãœï¼");
    }
</script>
</body>
</html>
